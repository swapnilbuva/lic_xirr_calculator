<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LIC XIRR Calculator</title>

<!-- Materialize CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<!-- SheetJS for Excel Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body.light-mode {
    background: #f1f3f4;
    color: #000;
}
body.dark-mode {
    background: #121212;
    color: #fff;
}
.dark-mode .card {
    background: #1e1e1e;
    color: #fff;
}
.dark-mode input {
    color: #fff;
}
.result-card {
    display: none;
}
.fade-in {
    animation: fadein 0.6s ease-out;
}
@keyframes fadein {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}
.theme-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
}
</style>
</head>

<body class="light-mode">

<!-- DARK MODE BUTTON -->
<button class="btn-floating btn-large blue lighten-1 theme-toggle z-depth-3" onclick="toggleTheme()">
    <i class="material-icons">brightness_6</i>
</button>

<div class="container" style="margin-top: 60px;">

    <div class="card z-depth-3">
        <div class="card-content">
            <span class="card-title center-align blue-text text-darken-3">
                <i class="material-icons">calculate</i> LIC XIRR Calculator
            </span>

            <!-- PLAN AUTOFILL -->
            <div class="row">
                <div class="input-field col s12">
                    <input id="planSearch" type="text" oninput="searchLICPlan()" autocomplete="off">
                    <label for="planSearch">Search LIC Plan (Name or Plan Number e.g. 948)</label>
                    <ul id="planSuggestions" class="collection" style="display:none; max-height:200px; overflow:auto;"></ul>
                </div>
            </div>

            <!-- FORM -->
            <div class="row">
                <div class="input-field col s12 m6">
                    <input id="pname" type="text">
                    <label for="pname">Policy Name</label>
                </div>

                <div class="input-field col s12 m6">
                    <input id="cdate" type="date">
                    <label class="active" for="cdate">Commencement Date</label>
                </div>

                <div class="input-field col s12 m6">
                    <input id="premium" type="number">
                    <label for="premium">Premium Amount</label>
                </div>

                <div class="input-field col s12 m6">
                    <input id="count" type="number">
                    <label for="count">Number of Premiums Paid</label>
                </div>

                <div class="input-field col s12 m6">
                    <input id="mdate" type="date">
                    <label class="active" for="mdate">Maturity Date</label>
                </div>

                <div class="input-field col s12 m6">
                    <input id="claim" type="number" value="0">
                    <label for="claim">Total Maturity / Payout</label>
                </div>
            </div>

            <div class="center-align">
                <button class="btn-large waves-effect waves-light blue" onclick="calculateXIRR()">
                    <i class="material-icons left">insights</i> Calculate XIRR
                </button>

                <button class="btn-large waves-effect waves-light green" onclick="exportExcel()">
                    <i class="material-icons left">file_download</i> Export Excel
                </button>
            </div>
        </div>
    </div>

    <!-- RESULT CARD -->
    <div id="resultCard" class="card result-card green lighten-5 z-depth-2 fade-in">
        <div class="card-content">
            <span class="card-title green-text text-darken-2">
                <i class="material-icons">trending_up</i> Result
            </span>
            <h5 id="resultText" class="black-text" style="margin-top: 10px;"></h5>
        </div>
    </div>

</div>

<script>
// ---------------------------------
// DARK MODE
// ---------------------------------
function toggleTheme() {
    document.body.classList.toggle("dark-mode");
    document.body.classList.toggle("light-mode");
}

// ---------------------------------
// LIC PLAN DATABASE
// ---------------------------------
const licPlans = [
    { number: 948, name: "LIC Jeevan Anand", term: 21, premium: 30000 },
    { number: 915, name: "LIC New Endowment Plan", term: 20, premium: 25000 },
    { number: 914, name: "LIC Money Back 20 Years", term: 20, premium: 28000 },
    { number: 943, name: "LIC Jeevan Lakshya", term: 15, premium: 35000 },
    { number: 945, name: "LIC Aadhaar Shila", term: 20, premium: 18000 }
];

function searchLICPlan() {
    let input = document.getElementById("planSearch").value.toLowerCase();
    let list = document.getElementById("planSuggestions");
    list.innerHTML = "";
    if (input.length < 1) {
        list.style.display = "none";
        return;
    }

    let filtered = licPlans.filter(p =>
        p.name.toLowerCase().includes(input) ||
        p.number.toString().includes(input)
    );

    filtered.forEach(p => {
        let li = document.createElement("li");
        li.className = "collection-item";
        li.textContent = `${p.number} - ${p.name}`;
        li.onclick = () => autofillPlan(p);
        list.appendChild(li);
    });

    list.style.display = filtered.length ? "block" : "none";
}

function autofillPlan(plan) {
    document.getElementById("pname").value = plan.name;
    document.getElementById("count").value = plan.term;
    document.getElementById("premium").value = plan.premium;

    M.updateTextFields(); // Materialize update
    document.getElementById("planSuggestions").style.display = "none";
}

// ---------------------------------
// XIRR CALCULATIONS
// ---------------------------------
function xnpv(rate, values, dates) {
    let t0 = dates[0];
    return values.reduce((sum, val, i) => {
        let diff = (dates[i] - t0) / (1000 * 3600 * 24);
        return sum + val / Math.pow(1 + rate, diff / 365);
    }, 0);
}

function xirr(values, dates) {
    let guess = 0.1;
    let eps = 1e-8;
    for (let i = 0; i < 100; i++) {
        let f = xnpv(guess, values, dates);
        let f1 = (xnpv(guess + eps, values, dates) - f) / eps;
        if (Math.abs(f1) < 1e-12) return null;
        let newGuess = guess - f / f1;
        if (Math.abs(newGuess - guess) < eps) return newGuess;
        guess = newGuess;
    }
    return null;
}

function calculateXIRR() {
    let pname = document.getElementById("pname").value || "LIC Policy";
    let cdate = new Date(document.getElementById("cdate").value);
    let premium = Number(document.getElementById("premium").value);
    let count = Number(document.getElementById("count").value);
    let mdate = new Date(document.getElementById("mdate").value);
    let claim = Number(document.getElementById("claim").value);

    if (!premium || !count || claim <= 0) {
        M.toast({html:"Please fill all fields properly!", classes:"red"});
        return;
    }

    let values = [], dates = [];

    for (let i = 0; i < count; i++) {
        let d = new Date(cdate);
        d.setFullYear(cdate.getFullYear() + i);
        values.push(-premium);
        dates.push(d);
    }

    values.push(claim);
    dates.push(mdate);

    let rate = xirr(values, dates);

    const resultCard = document.getElementById("resultCard");
    const resultText = document.getElementById("resultText");

    if (!rate || !isFinite(rate)) {
        resultText.innerHTML = `<b>${pname}</b><br>Unable to compute XIRR.`;
    } else {
        resultText.innerHTML = `<b>${pname}</b><br>XIRR: <strong>${(rate*100).toFixed(2)}%</strong>`;
    }

    resultCard.style.display = "block";
}

// ---------------------------------
// EXPORT EXCEL
// ---------------------------------
function exportExcel() {
    let data = [
        ["Field", "Value"],
        ["Policy Name", document.getElementById("pname").value],
        ["Premium", document.getElementById("premium").value],
        ["Premium Count", document.getElementById("count").value],
        ["Commencement Date", document.getElementById("cdate").value],
        ["Maturity Date", document.getElementById("mdate").value],
        ["Claim", document.getElementById("claim").value]
    ];

    let ws = XLSX.utils.aoa_to_sheet(data);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "LIC XIRR");

    XLSX.writeFile(wb, "LIC_XIRR_Report.xlsx");
}
</script>

</body>
</html>
