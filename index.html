<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LIC XIRR Calculator</title>

<!-- Materialize CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
body {
    background: #f1f3f4;
}
.card {
    border-radius: 16px;
}
.result-card {
    display: none;
}
.fade-in {
    animation: fadein 0.6s ease-out;
}
@keyframes fadein {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
</head>

<body>

<div class="container" style="margin-top: 40px;">

    <div class="card z-depth-3">
        <div class="card-content">
            <span class="card-title center-align blue-text text-darken-3">
                <i class="material-icons">calculate</i> LIC XIRR Calculator
            </span>

            <!-- FORM -->
            <div class="row">
                <div class="input-field col s12 m6">
                    <input id="pname" type="text">
                    <label for="pname">Policy Name</label>
                </div>

                <div class="input-field col s12 m6">
                    <input id="cdate" type="date" class="datepicker">
                    <label for="cdate">Commencement Date</label>
                </div>

                <div class="input-field col s12 m6">
                    <input id="premium" type="number">
                    <label for="premium">Premium Amount</label>
                </div>

                <div class="input-field col s12 m6">
                    <input id="count" type="number">
                    <label for="count">Number of Premiums Paid</label>
                </div>

                <div class="input-field col s12 m6">
                    <input id="mdate" type="date" class="datepicker">
                    <label for="mdate">Maturity Date</label>
                </div>

                <div class="input-field col s12 m6">
                    <input id="claim" type="number" value="0">
                    <label for="claim">Total Maturity / Payout</label>
                </div>
            </div>

            <div class="center-align">
                <button class="btn-large waves-effect waves-light blue" onclick="calculateXIRR()">
                    <i class="material-icons left">insights</i> Calculate XIRR
                </button>
            </div>
        </div>
    </div>

    <!-- RESULT CARD -->
    <div id="resultCard" class="card result-card green lighten-5 z-depth-2 fade-in">
        <div class="card-content">
            <span class="card-title green-text text-darken-2">
                <i class="material-icons">trending_up</i> Result
            </span>
            <h5 id="resultText" class="black-text" style="margin-top: 10px;"></h5>
        </div>
    </div>

</div>

<!-- Materialize JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<script>
// ----------- XNPV ----------
function xnpv(rate, values, dates) {
    let t0 = dates[0];
    return values.reduce((acc, val, i) => {
        let diff = (dates[i] - t0) / (1000 * 3600 * 24);
        return acc + val / Math.pow(1 + rate, diff / 365);
    }, 0);
}

// ----------- ROBUST XIRR ----------
function xirr(values, dates) {
    let guess = 0.1;
    let eps = 1e-8;

    for (let i = 0; i < 100; i++) {
        let f = xnpv(guess, values, dates);
        let f1 = (xnpv(guess + eps, values, dates) - f) / eps;

        if (Math.abs(f1) < 1e-12) return null;

        let newGuess = guess - f / f1;
        if (Math.abs(newGuess - guess) < eps) return newGuess;
        guess = newGuess;
    }
    return null;
}

// ----------- MAIN CALCULATOR ----------
function calculateXIRR() {
    let pname = document.getElementById("pname").value || "LIC Policy";
    let cdate = new Date(document.getElementById("cdate").value);
    let premium = Number(document.getElementById("premium").value);
    let count = Number(document.getElementById("count").value);
    let mdate = new Date(document.getElementById("mdate").value);
    let claim = Number(document.getElementById("claim").value);

    if (claim <= 0 || !premium || !count || isNaN(cdate.getTime()) || isNaN(mdate.getTime())) {
        M.toast({html: "Please fill all fields properly!", classes: "red"});
        return;
    }

    let values = [], dates = [];

    for (let i = 0; i < count; i++) {
        let d = new Date(cdate);
        d.setFullYear(cdate.getFullYear() + i);
        values.push(-premium);
        dates.push(d);
    }

    values.push(claim);
    dates.push(mdate);

    let rate = xirr(values, dates);

    const resultCard = document.getElementById("resultCard");
    const resultText = document.getElementById("resultText");

    if (!rate || !isFinite(rate)) {
        resultText.innerHTML = `<b>${pname}</b><br>Unable to compute XIRR. Check the cashflows.`;
    } else {
        resultText.innerHTML = `<b>${pname}</b><br>XIRR: <strong>${(rate * 100).toFixed(2)}%</strong>`;
    }

    resultCard.style.display = "block";
}
</script>

</body>
</html>
